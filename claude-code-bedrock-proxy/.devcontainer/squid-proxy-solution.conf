# Squid proxy configuration for domain-based filtering
# This allows dynamic DNS resolution without IP caching

# Basic settings
http_port 3128
cache deny all

# ACL definitions for allowed domains
acl allowed_domains dstdomain .amazonaws.com
acl bedrock_domains dstdomain bedrock.us-east-1.amazonaws.com
acl bedrock_domains dstdomain bedrock-runtime.us-east-1.amazonaws.com
acl bedrock_domains dstdomain bedrock-fips.us-east-1.amazonaws.com
acl bedrock_domains dstdomain bedrock-agent.us-east-1.amazonaws.com
acl bedrock_domains dstdomain bedrock-agent-runtime.us-east-1.amazonaws.com
acl bedrock_domains dstdomain sts.us-east-1.amazonaws.com
acl bedrock_domains dstdomain sts.amazonaws.com

# GitHub domains
acl github_domains dstdomain .github.com
acl github_domains dstdomain .githubusercontent.com

# Other allowed services
acl npm_domains dstdomain registry.npmjs.org
acl anthropic_domains dstdomain api.anthropic.com
acl anthropic_domains dstdomain sentry.io
acl anthropic_domains dstdomain statsig.anthropic.com
acl anthropic_domains dstdomain statsig.com

# SSL ports
acl SSL_ports port 443
acl CONNECT method CONNECT

# Allow CONNECT only to SSL ports
http_access deny CONNECT !SSL_ports

# Allow access to specific domains
http_access allow bedrock_domains
http_access allow github_domains
http_access allow npm_domains
http_access allow anthropic_domains

# Deny all other access
http_access deny all

# DNS settings - critical for dynamic resolution
# dns_v4_first is obsolete in newer Squid versions, removed
positive_dns_ttl 30 seconds
negative_dns_ttl 5 seconds

# Disable caching to ensure fresh DNS lookups
cache deny all
refresh_pattern . 0 0% 0

# Logging
access_log /var/log/squid/access.log
cache_log /var/log/squid/cache.log